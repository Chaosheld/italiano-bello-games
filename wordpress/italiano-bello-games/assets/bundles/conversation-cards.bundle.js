function t(n,s={},...e){const c=document.createElement(n);return Object.entries(s).forEach(([i,a])=>{i==="class"?c.className=a:c.setAttribute(i,a)}),e.flat().forEach(i=>{i!=null&&c.append(typeof i=="string"?document.createTextNode(i):i)}),c}function x(n){n.innerHTML=""}const B=(window.__IB_PUBLIC_BASE__||"/").replace(/\/?$/,"/"),b=B+"games/conversation-cards/",k=b+"assets/card_back_01.svg",C=b+"assets/sfx/card-flip.mp3",E=b+"content.json",L={beginner:"ðŸŒ±",advanced:"ðŸš€"},I={casa:"ðŸ ",vacanze:"ðŸ–ï¸",giornata:"ðŸ•’",cibo:"ðŸ",lavoro:"ðŸ’¼",viaggi:"âœˆï¸",relazioni:"ðŸ‘¥",tecnologia:"ðŸ‘¥",cultura:"ðŸŽ­",scuola:"ðŸŽ“",salute:"ðŸ§˜",citta:"ðŸ™ï¸",routine:"ðŸ—“ï¸",opinioni:"ðŸ’¬"};class z{constructor(s,e={}){this.root=s,this.opts=e,this.state={content:null,levelId:null,topicId:null,deck:[],discard:[],showHelp:!1},this.jitter=this.makeJitter(20),this.isAnimating=!1,this.sfx=null}async init(){this.root.classList.add("cc-wrap"),await this.loadContent(),this.opts.level&&(this.state.levelId=this.opts.level),this.opts.topic&&(this.state.topicId=this.opts.topic),this.initSfx(),this.state.levelId&&this.state.topicId?(this.startDeck(),this.renderBoard()):this.state.levelId?this.renderTopicSelect():this.renderHome()}initSfx(){try{const s=new Audio(C);s.preload="auto",s.volume=.65,this.sfx=s}catch{this.sfx=null}}playSfx(){if(this.sfx)try{this.sfx.currentTime=0,this.sfx.play().catch(()=>{})}catch{}}async loadContent(){const s=await fetch(E,{cache:"no-store"});if(!s.ok)throw new Error("Impossibile caricare content.json");this.state.content=await s.json()}renderShell(s){x(this.root);const e=this.state.content.title||"Carte di conversazione",c=t("div",{class:"cc-topbar"},t("div",{class:"cc-topbar-left"},t("h1",{class:"cc-title"},e),t("div",{class:"cc-subtitle"},"Conversazione"))),i=t("div",{class:"cc-body"},s);this.root.append(c,i)}renderHome(){const s=t("div",{},t("h2",{class:"cc-h2"},"Scegli il livello"),t("p",{class:"cc-sub"},"Seleziona un livello e un tema. Poi pesca le carte dal mazzo.")),e=t("div",{class:"cc-grid"});this.state.content.levels.forEach(c=>{const i=L[c.id]||"ðŸŽ¯",a=t("button",{class:"cc-choice",type:"button"},t("div",{class:"cc-choice-row"},t("div",{class:"cc-choice-title"},`${i} ${c.label}`),t("div",{class:"cc-choice-meta"},`${c.topics.length} temi`)));a.addEventListener("click",()=>{this.state.levelId=c.id,this.state.topicId=null,this.renderTopicSelect()}),e.append(a)}),s.append(e),this.renderShell(s)}renderTopicSelect(){const s=this.getLevel(),e=t("button",{class:"cc-btn",type:"button"},"â† Menu");e.addEventListener("click",()=>this.renderHome());const c=t("div",{},e,t("h2",{class:"cc-h2",style:"margin-top:12px;"},"Scegli un tema"),t("p",{class:"cc-sub"},"Le carte sono mescolate automaticamente.")),i=t("div",{class:"cc-grid"});s.topics.forEach(a=>{const o=I[a.id]||"ðŸ—‚ï¸",r=t("button",{class:"cc-choice",type:"button"},t("div",{class:"cc-choice-row"},t("div",{class:"cc-choice-title"},`${o} ${a.label}`),t("div",{class:"cc-choice-meta"},`${a.cards.length} carte`)));r.addEventListener("click",()=>{this.state.topicId=a.id,this.startDeck(),this.renderBoard()}),i.append(r)}),c.append(i),this.renderShell(c)}renderBoard(){const s=this.getLevel(),e=this.getTopic(),c=t("div",{class:"cc-headerrow"},t("div",{class:"cc-kickerline"},`${s.label} Â· ${e.label}`),t("div",{class:"cc-head-actions"},this.headBtn("â† Temi",()=>this.renderTopicSelect()),this.headBtn("â†» Ricomincia",()=>{this.startDeck(),this.renderBoard()}),this.headBtn("â˜° Menu",()=>this.renderHome()))),i=t("div",{class:"cc-slots"}),a=Math.min(this.state.deck.length,20),o=Math.min(this.state.discard.length,20),r=t("div",{class:"cc-slot"}),d=t("button",{class:"cc-slotbtn",type:"button"});d.addEventListener("click",()=>this.drawNextAnimated());const h=t("div",{class:"cc-stack","data-stack":"left"},...this.buildBackStack(a)),p=t("div",{class:"cc-slotmeta"},t("div",{class:"cc-slotlabel"},"Mazzo"),t("div",{class:"cc-slotsub"},this.state.deck.length?"Clicca sul mazzo per pescare":"Mazzo finito"),t("div",{class:"cc-slotcount"},`Rimaste: ${this.state.deck.length}`));d.append(h),r.append(d,p);const v=t("div",{class:"cc-slot"}),l=t("div",{class:"cc-slotbtn cc-slotbtn-passive"}),f=t("div",{class:"cc-stack","data-stack":"right"},...this.buildFaceStack(o)),u=this.state.discard[0]||null,S=t("div",{class:"cc-slotmeta"},t("div",{class:"cc-slotlabel"},"Carte pescate"),t("div",{class:"cc-slotsub"},u?"Carta attuale":"In attesa della prima carta"),t("div",{class:"cc-slotcount"},`Viste: ${this.state.discard.length}`));l.append(f),v.append(l,S),i.append(r,v);const g=t("div",{class:"cc-below"}),m=t("button",{class:"cc-helpbtn",type:"button"},this.state.showHelp?"Nascondi aiuto":"Aiuto linguistico");m.disabled=!u,m.addEventListener("click",()=>{this.state.showHelp=!this.state.showHelp,this.renderBoard()}),g.append(m);const y=t("div",{},c,i,g);this.state.showHelp&&u&&u.help&&y.append(this.helpPanel(u.help)),this.renderShell(y),this.applyStackTransforms()}async drawNextAnimated(){if(this.isAnimating)return;if(this.state.deck.length===0){this.renderEnd();return}this.isAnimating=!0;const s=this.state.deck[0];this.playSfx();const e=this.root.querySelector('[data-stack="left"]'),c=this.root.querySelector('[data-stack="right"]');if(!e||!c||!s){this.drawNextImmediate();return}const i=e.getBoundingClientRect(),a=c.getBoundingClientRect(),o=Math.min(i.width,a.width),r=Math.min(i.height,a.height),d=i.left+i.width/2,h=i.top+i.height/2,p=a.left+a.width/2,v=a.top+a.height/2,l=t("div",{class:"cc-flycard"},t("div",{class:"cc-flyinner"},t("div",{class:"cc-flyface cc-flyback"},t("img",{class:"cc-cardimg",src:k,alt:""})),t("div",{class:"cc-flyface cc-flyfront"},t("div",{class:"cc-cardface"},t("div",{class:"cc-cardcontent"},t("div",{class:"cc-q"},s.q))))));document.body.appendChild(l),l.style.width=`${o}px`,l.style.height=`${r}px`,l.style.left=`${d-o/2}px`,l.style.top=`${h-r/2}px`,l.getBoundingClientRect(),l.classList.add("is-flying"),l.style.left=`${p-o/2}px`,l.style.top=`${v-r/2}px`,await this.sleep(190),l.classList.add("is-flipped"),await this.sleep(210);const f=this.state.deck.shift();this.state.discard.unshift(f),this.state.showHelp=!1,this.renderBoard(),await this.sleep(120),l.classList.add("is-fading"),await this.sleep(120),l.remove(),this.isAnimating=!1}drawNextImmediate(){const s=this.state.deck.shift();this.state.discard.unshift(s),this.state.showHelp=!1,this.renderBoard(),this.isAnimating=!1}buildBackStack(s){if(s===0)return[t("div",{class:"cc-dropzone"},t("div",{class:"cc-dropzone-title"},"Mazzo vuoto"),t("div",{class:"cc-dropzone-sub"},"Clicca per vedere il riepilogo."))];const e=[];for(let c=s-1;c>=0;c--){const i=Math.min(c,19);e.push(t("div",{class:"cc-layer","data-layer":String(i)},t("img",{class:"cc-cardimg",src:k,alt:""})))}return e}buildFaceStack(s){const e=this.state.discard[0]||null;if(!e)return[t("div",{class:"cc-dropzone"},t("div",{class:"cc-dropzone-title"},"Carta pescata"),t("div",{class:"cc-dropzone-sub"},"Qui apparirÃ  la carta."))];const c=[],i=Math.max(1,s);for(let a=i-1;a>=0;a--){const o=Math.min(a,19);a===0?c.push(t("div",{class:"cc-layer","data-layer":String(o),"data-top":"1"},t("div",{class:"cc-cardface"},t("div",{class:"cc-cardcontent"},t("div",{class:"cc-q"},e.q))))):c.push(t("div",{class:"cc-layer","data-layer":String(o)},t("div",{class:"cc-cardface cc-blank"},"")))}return c}makeJitter(s){const e=[],c=(i,a)=>i+Math.random()*(a-i);for(let i=0;i<s;i++){const a=i%2===0?-1:1,o=i*2.6,r=a*(i*.18),d=a*c(.35,1.2),h=r+a*c(.3,1.6),p=o+c(.2,1.2);e.push({rot:d,x:h,y:p})}return e[0]={rot:0,x:0,y:0},e}applyStackTransforms(){this.root.querySelectorAll(".cc-layer[data-layer]").forEach(e=>{const c=parseInt(e.getAttribute("data-layer"),10),i=this.jitter[c]||{rot:0,x:0,y:0};if(e.style.zIndex=String(1e3-c),e.getAttribute("data-top")==="1"){e.style.setProperty("--jx","0px"),e.style.setProperty("--jy","0px"),e.style.setProperty("--jrot","0deg");return}e.style.setProperty("--jx",`${i.x}px`),e.style.setProperty("--jy",`${i.y}px`),e.style.setProperty("--jrot",`${i.rot}deg`)})}helpPanel(s){return t("div",{class:"cc-help"},t("div",{class:"cc-help-title"},"Aiuto linguistico"),t("div",{class:"cc-help-grid"},this.helpBlock("Frasi utili",s.starter),this.helpBlock("Strutture",s.structures),this.helpBlock("Parole chiave",s.lexicon)))}helpBlock(s,e=[]){const c=(e||[]).filter(Boolean);return t("div",{class:"cc-help-block"},t("h4",{},s),c.length?t("ul",{},...c.map(i=>t("li",{},i))):t("div",{class:"cc-muted"},"â€”"))}headBtn(s,e){const c=t("button",{class:"cc-headbtn",type:"button"},s);return c.addEventListener("click",e),c}renderEnd(){const s=this.getLevel(),e=this.getTopic(),c=t("button",{class:"cc-btn primary",type:"button"},"Ricomincia (mescola) â†»");c.addEventListener("click",()=>{this.startDeck(),this.renderBoard()});const i=t("button",{class:"cc-btn",type:"button"},"Cambia tema");i.addEventListener("click",()=>this.renderTopicSelect());const a=t("button",{class:"cc-btn",type:"button"},"Menu iniziale");a.addEventListener("click",()=>this.renderHome());const o=t("div",{class:"cc-end"},t("div",{class:"cc-stars"},"â­â­â­"),t("h2",{class:"cc-h2"},"Ottimo lavoro!"),t("p",{class:"cc-sub"},`Hai completato tutte le carte: ${s.label} Â· ${e.label}`),t("div",{class:"cc-controls",style:"justify-content:center;"},c,i,a));this.renderShell(o)}startDeck(){const s=this.getTopic();this.state.deck=$([...s.cards]),this.state.discard=[],this.state.showHelp=!1}getLevel(){const s=this.state.content.levels.find(e=>e.id===this.state.levelId);if(!s)throw new Error("Livello non trovato");return s}getTopic(){const e=this.getLevel().topics.find(c=>c.id===this.state.topicId);if(!e)throw new Error("Tema non trovato");return e}sleep(s){return new Promise(e=>setTimeout(e,s))}}function $(n){for(let s=n.length-1;s>0;s--){const e=Math.floor(Math.random()*(s+1));[n[s],n[e]]=[n[e],n[s]]}return n}function w(){document.querySelectorAll(".ib-conversation-cards").forEach(n=>{const s=n.dataset.level||"",e=n.dataset.topic||"";new z(n,{level:s,topic:e}).init()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",w):w();
